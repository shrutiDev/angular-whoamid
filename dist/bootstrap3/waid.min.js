"use strict";angular.module("waid.core.app.strategy",["waid.core","waid.core.services","ui.bootstrap","angular-growl","slugifier","angular-confirm"]).service("waidCoreAppStrategy",function($q,$rootScope,$uibModal,waidCore,waidService,$location,$cookies,growl,Slug){var emoticonsModalInstance=null,termsAndConditionsModalInstance=null,completeProfileModalInstance=null,lostLoginModalInstance=null,loginAndRegisterHomeModalInstance=null,userProfileHomeModalInstance=null,loginCount=0;waidCore.slugify=function(slug){return Slug.slugify($location.absUrl())},waidCore.checkIfModalIsOpen=function(modal){return!("completeProfile"!=modal||!completeProfileModalInstance)},waidCore.closeAllModals=function(){this.closeEmoticonsModal(),this.closeTermsAndConditionsModal(),this.closeCompleteProfileModal(),this.closeLostLoginModal(),this.closeLoginAndRegisterModal(),this.closeUserProfileModal()},waidCore.openEmoticonsModal=function(targetId,comment){var input=document.getElementById(targetId);return emoticonsModalInstance=$uibModal.open({animation:!0,templateUrl:waidCore.config.getTemplateUrl("core","emoticonsModal"),controller:"WAIDCoreEmoticonModalCtrl",resolve:{comment:function(){return comment},selectionStart:function(){return input.selectionStart}},size:"lg",backdrop:"static"}),emoticonsModalInstance.result},waidCore.closeEmoticonsModal=function(comment){emoticonsModalInstance&&("undefined"!=typeof comment?emoticonsModalInstance.close(comment):emoticonsModalInstance.dismiss("close"),$rootScope.$broadcast("waid.bootstrap3.strategy.closeEmoticonsModal"))},waidCore.openTermsAndConditionsModal=function(template){termsAndConditionsModalInstance=$uibModal.open({animation:!0,controller:"WAIDIDMTermsAndConditionsCtrl",templateUrl:waidCore.config.getTemplateUrl("idm","termsAndConditionsModal"),size:"lg",backdrop:"static"})},waidCore.closeTermsAndConditionsModal=function(){termsAndConditionsModalInstance&&(termsAndConditionsModalInstance.dismiss("close"),$rootScope.$broadcast("waid.bootstrap3.strategy.closeTermsAndConditionsModal"))},waidCore.openCompleteProfileModal=function(){completeProfileModalInstance=$uibModal.open({animation:!0,templateUrl:waidCore.config.getTemplateUrl("idm","completeProfileModal"),controller:"WAIDIDMCompleteProfileCtrl",size:"lg",backdrop:"static"})},waidCore.closeCompleteProfileModal=function(){completeProfileModalInstance&&(completeProfileModalInstance.dismiss("close"),$rootScope.$broadcast("waid.bootstrap3.strategy.closeCompleteProfileModal"))},waidCore.openLostLoginModal=function(){lostLoginModalInstance=$uibModal.open({animation:!0,templateUrl:waidCore.config.getTemplateUrl("idm","lostLoginModal"),size:"lg",backdrop:"static"})},waidCore.closeLostLoginModal=function(){lostLoginModalInstance&&(lostLoginModalInstance.dismiss("close"),$rootScope.$broadcast("waid.bootstrap3.strategy.closeLostLoginModal"))},waidCore.openLoginAndRegisterHomeModal=function(){loginAndRegisterHomeModalInstance=$uibModal.open({animation:!0,templateUrl:waidCore.config.getTemplateUrl("idm","loginAndRegisterModal"),size:"lg",backdrop:"static"})},waidCore.closeLoginAndRegisterModal=function(){loginAndRegisterHomeModalInstance&&(loginAndRegisterHomeModalInstance.dismiss("close"),$rootScope.$broadcast("waid.bootstrap3.strategy.closeLoginAndRegisterModal"))},waidCore.openUserProfileHomeModal=function(fieldSet){userProfileHomeModalInstance=$uibModal.open({animation:!0,templateUrl:waidCore.config.getTemplateUrl("idm","userProfileModal"),size:"lg",backdrop:"static",controller:["$scope","currentFieldSet",function($scope,currentFieldSet){$scope.currentFieldSet=currentFieldSet}],resolve:{currentFieldSet:function(){return"undefined"==typeof fieldSet?"overview":fieldSet}}})},waidCore.closeUserProfileModal=function(){userProfileHomeModalInstance&&(userProfileHomeModalInstance.dismiss("close"),$rootScope.$broadcast("waid.bootstrap3.strategy.closeUserProfileModal"))},waidCore.openEmoticons=function(targetId,comment){waidCore.openEmoticonsModal(targetId,comment)},waidCore.openTermsAndConditions=function(){waidCore.openTermsAndConditionsModal()},waidCore.openCompleteProfile=function(){waidCore.openCompleteProfileModal()},waidCore.openLostLogin=function(){waidCore.openLostLoginModal()},waidCore.openLoginAndRegisterHome=function(){waidCore.openLoginAndRegisterHomeModal()},waidCore.openLoginAndRegisterHome=function(){waidCore.openLoginAndRegisterHomeModal()},waidCore.openUserProfileHome=function(fieldSet){waidCore.openUserProfileHomeModal(fieldSet)},$rootScope.$on("waid.services.request.noPermission",function(event,data){waidService.token&&0==waidCore.checkIfModalIsOpen("completeProfile")&&waidService.userCompleteProfileGet().then(function(data){waidCore.loginCheck(data)})}),$rootScope.$on("waid.services.application.userCompleteProfile.post.ok",function(event,data){data.profile_status.indexOf("profile_ok")!==-1&&setTimeout(function(){waidService.authenticate()},1e3),waidCore.closeCompleteProfileModal(),data.profile_status.indexOf("email_is_not_verified")!==-1&&growl.addErrorMessage("Er is activatie e-mail verstuurd. Controleer je e-mail om de login te verifieren.",{ttl:-1})}),$rootScope.$on("waid.core.strategy.loginCheck.completeProfile",function(event,data){waidCore.closeAllModals(),waidCore.openCompleteProfileModal()}),$rootScope.$on("waid.core.strategy.loginCheck.success",function(event,data){growl.addSuccessMessage(waidCore.config.getConfig("idm.translations.loggedin_success")),waidCore.closeAllModals()}),$rootScope.$on("waid.services.application.userEmail.post.ok",function(event,data){growl.addSuccessMessage("Nieuw e-mail adres toegevoegd, controleer je mail om deze te verifieren.",{ttl:-1})}),$rootScope.$on("waid.services.application.userProfile.patch.ok",function(event,data){waidCore.user=data,growl.addSuccessMessage("Profiel informatie opgeslagen")}),$rootScope.$on("waid.services.application.userProfile.get.ok",function(event,data){waidCore.user=data}),$rootScope.$on("waid.services.application.userPassword.put.ok",function(event,data){growl.addSuccessMessage("Wachtwoord is gewijzigd.")}),$rootScope.$on("waid.services.application.userUsername.put.ok",function(event,data){growl.addSuccessMessage("Gebruikersnaam is gewijzigd.")}),$rootScope.$on("waid.services.application.userLostLogin.post.ok",function(event,data){growl.addSuccessMessage("Instructies om in te loggen zijn naar jouw e-mail gestuurd."),waidCore.closeAllModals()}),$rootScope.$on("waid.services.application.userRegister.post.ok",function(event,data){growl.addSuccessMessage("Je account is aangemaakt. Ga naar je mailbox om je account te verifiÃ«ren.",{ttl:-1})}),$rootScope.$on("waid.services.application.userRegister.post.ok",function(event,data){waidCore.closeAllModals()}),$rootScope.$on("waid.services.application.userLogout.post.ok",function(event,data){waidCore.closeAllModals()}),$rootScope.$on("waid.services.application.userLogoutAll.post.ok",function(event,data){waidCore.closeAllModals()}),$rootScope.$on("waid.services.application.userAutoLogin.get.ok",function(event,data){waidCore.loginCheck(data)}),$rootScope.$on("waid.services.application.userLogin.post.ok",function(event,data){waidCore.loginCheck(data)}),$rootScope.$on("waid.core.strategy.errorCode",function(event,data){growl.addErrorMessage(waidCore.config.getTranslation("idm",data.errorCode))}),$rootScope.$on("waid.services.application.userLogin.post.error",function(event,data){loginCount++,loginCount>3&&(waidCore.openLostLoginModal(),loginCount=0)})}).config(["growlProvider",function(growlProvider){growlProvider.globalTimeToLive(5e3)}]);